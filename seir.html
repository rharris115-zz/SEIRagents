<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SEIR</title>
    <script src="./node_modules/random-js/lib/random.js" type="text/javascript"></script>
    <script src="./node_modules/prob.js/prob.js"></script>
    <script src="./node_modules/tinyqueue/tinyqueue.js"></script>
    <script src="./node_modules/kd-tree-javascript/kdTree.js"></script>
    <script src="./node_modules/chance/chance.js"></script>
</head>
<body>

<canvas id="seirCanvas" width="400" height="400" style="border:1px solid #000000;"></canvas>

<script type="module">

    import {Population, unit_square_distribution} from "./src/Population.js"
    import {State} from "./src/State.js"
    import {GravityContactSampler} from "./src/GravityContactSampler.js"
    import {SEIRModel} from "./src/SEIRModel.js";

    let n = 1000
    let exponent = -2
    let maxDistance = 0.25
    let outbreakSize = 1

    let contact_rate_per_individual = 1.0


    let pop = Population.of(n, index => "Agent_" + index.toString()).assignAttributes(unit_square_distribution)

    let gravity = GravityContactSampler.builder(pop)
        .withMaxDistance(maxDistance)
        .withExponent(exponent)
        .build()

    pop.sample(outbreakSize).forEach(individual => {
        individual.state = State.Exposed
    })


    let model = SEIRModel.builder(gravity)
        .withContactsTime(Prob.exponential(n * contact_rate_per_individual))
        .withExposedTime(Prob.lognormal(2, 0.5)) // mean: 8.372897488127265 stdev: 4.462254918069333
        .withInfectedTime(Prob.lognormal(2, 0.5)) // mean: 8.372897488127265 stdev: 4.462254918069333
        .build()

    model.setupEvents()

    for (let day = 1; day < 200; day++) {
        model.eventQueue.runUntil(day)

        let sCount = pop.withState(State.Susceptible).length
        let eCount = pop.withState(State.Exposed).length
        let iCount = pop.withState(State.Infected).length
        let rCount = pop.withState(State.Removed).length

        drawPopulation(pop, 4, {
            [State.Susceptible]: '#2ca02c',
            [State.Exposed]: '#bcbd22',
            [State.Infected]: '#ff7f0e',
            [State.Removed]: '#7f7f7f'
        })
    }

    function drawPopulation(pop, size, stateColors) {
        let canvas = document.getElementById("seirCanvas")
        let ctx = canvas.getContext("2d")
        pop.asArray.forEach(individual => {
            ctx.fillStyle = stateColors[individual.state]
            let cx = individual.x * canvas.width
            let cy = individual.y * canvas.height
            ctx.fillRect(cx - size / 2, cy - size / 2, size, size)
        })
    }

</script>


</body>
</html>
